# set -g default-shell /bin/zsh

# Address vim mode switching delay (http://superuser.com/a/252717/65504)
set -sg escape-time 0

set -g history-limit 4000

# Increase tmux messages display duration from 750ms to 4s
set -g display-time 4000

# start index
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# Emacs key bindings in tmux command prompt (prefix + :) are better than
# vi keys, even for vim users

# scroll vi motions when in search mode
setw -g mode-keys vi
set -g status-keys emacs

# Focus events enabled for terminals that support them
set -g focus-events on

# clipboard
set -g set-clipboard on

# Super useful when using "grouped sessions" and multi-monitor setup
setw -g aggressive-resize on

# with mouse (click on pretty little boxes)
set-option -g mouse on
set -g mouse on
set-option -g focus-events on
unbind-key -T copy-mode-vi MouseDragEnd1Pane


# better compatibility with TERM env var
set -g default-terminal "xterm-256color"
# re-add 256 colors
set-option -sa terminal-overrides ",xterm-256color:RGB"

# override prefix 
unbind C-b
set-option -g prefix C-e
bind-key C-e send-prefix

# source config file
bind r source-file ~/.tmux.conf

# easy-to-remember split pane commands
unbind '"'
unbind %
bind v split-window -c  "#{pane_current_path}" -h -l 30%
bind V split-window -c  "#{pane_current_path}" -hf -l 50%
bind s split-window -c  "#{pane_current_path}" -v -l 20%
bind S split-window -c  "#{pane_current_path}" -vf  -l 50%

# cmd prompt
bind : command-prompt

# moving between panes with vim movement keys
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# resize the pane
bind-key -r J resize-pane -D 6
bind-key -r K resize-pane -U 6
bind-key -r H resize-pane -L 10
bind-key -r L resize-pane -R 10

# enter copy mode (to scroll)
bind-key u copy-mode
# bind-key -T root PageUp copy-mode
bind-key -T copy-mode-vi y send -X copy-selection -x
bind-key -T copy-mode-vi Escape send q 
bind-key -T copy-mode-vi v send -X begin-selection

# kill a pane
unbind q 
bind q kill-pane

# kill a window
unbind &
bind Q kill-window

# window bindings
unbind c
unbind p
unbind t
# bind c new-window -c '#{pane_current_path}'
# bind c new-window 
bind t command-prompt -p "name:" "new-window -c '#{pane_current_path}' -a -n '%%'"
bind b previous-window
bind n next-window 
bind -r < swap-window -t -1 -d
bind -r > swap-window -t +1 -d
# there's already a default bind on 'o' to rotate panes
# bind -r e swap-pane -t +1 -d

# Status modules
set -g status-interval 1

# status color palette 
set-option -g @thm_white_light "#FFFFFF"
set-option -g @thm_white "#eeeeee"
set-option -g @thm_white_dark "#BABABA"

set-option -g @thm_grey_light "#d6d6d6"
set-option -g @thm_grey "#656565"
set-option -g @thm_grey_dark "#222222"

set-option -g @thm_black_light "#323232"
set-option -g @thm_black "#1C1C1C"
set-option -g @thm_black_dark "#0A0A0A"

set-option -g @thm_yellow_light "#D2B887"
#set-option -g @thm_yellow "#FFC14B"
set-option -g @thm_yellow "#ffcf70"
set-option -g @thm_yellow_dark "#fab387"

#set-option -g @thm_green_light "#C8CF5B"
set-option -g @thm_green_light "#88f2a9"
set-option -g @thm_green "#9FAA00"

set-option -g @thm_blue_light "#DDECF2"
#set-option -g @thm_blue "#72CDF4"
set-option -g @thm_blue "#5fc8f5"

set-option -g @thm_red_light "#F43753"
set-option -g @thm_red "#660303"
set-option -g @thm_red_dark "#611b1b"

set-option -g @thm_magenta_light "#ba87d3"
set-option -g @thm_magenta "#972ecc"

set-option -g @thm_purple_light "#9e90e5"
set-option -g @thm_purple "#432ead"

set-option -g @thm_orange_light "#ed8b4a"
set-option -g @thm_orange "#a36033"

# Dark palette
set-option -g @thm_yellow_dark  "#b97a4b"   # peach amber
set-option -g @thm_green_dark   "#5c805c"   # desaturated green
set-option -g @thm_blue_dark    "#3b5360"   # slate blue-grey
set-option -g @thm_red_dark     "#7a2e2e"   # deep muted red
set-option -g @thm_orange_dark  "#a35d2e"   # burnt orange
set-option -g @thm_purple_dark  "#7a5f7e"   # dusty violet
set-option -g @thm_magenta_dark "#684c61"   # muted magenta


# pane border style
set -g pane-active-border-style "fg=#{@thm_purple_light}"

# vi mode select colors
set -g mode-style "bg=#{@thm_purple_light},fg=black"

# status command line style
set -g message-style "bg=#{@thm_yellow_light},fg=#{@thm_black_dark}"
set -g message-command-style "bg=#{@thm_yellow_light},fg=#{@thm_black_dark}"

# status style
set -g status-style "fg=#{@thm_white},bold"
set-option -g @status_bg "#{?client_prefix,#{@thm_white_dark},#{@thm_grey_dark}}"
set -ag status-style "bg=#{E:@status_bg}"

# disable status left
set-option -g status-left ""

# window status settings
# '#W' means current window name
set -g status-left-length 100
set -g window-status-format "[#{window_index}]#W "
set -g window-status-current-format "[#{window_index}]#W* "
set -g window-status-style "bg=#{@thm_grey_dark}"
# set -g window-status-current-style "bg=#483a4f"
set -g window-status-current-style "bg=#{@thm_red}"


# right status settings
set -g status-right ""
set -ag status-right "#[fg=#{@thm_white}]ü¶≠üêàü¶ï ≥·µÉ ∑ ≥ ≥ü¶ßüöÄüíª "

%if "#{==:#{host},macbookm3}"
# mac
    set-option -g @eval_cpu_pct "#(iostat -c 2 disk0 | sed '/^\s*$/d' | tail -n 1 | awk -v format=\"%%2.0f\" '{usage=100-$6} END {printf(format, usage) }' | sed 's/,/./')"

    set-option -g @eval_ram_total "#(sysctl hw.memsize | sed 's/hw.memsize: //' | awk -v format=\"%%.1fG\" '{printf(format, \$1 / 1024 / 1024 / 1024)}')"

    set-option -g @eval_ram_usage "#(vm_stat | awk '/Pages active/ {active=\$3} /Pages free/ {free=\$3} /Pages wired down/ {wired=\$4} /Pages speculative/ {speculative=\$3} /Pages inactive/ {inactive=\$3} /Pages purgeable/ {purgeable=\$3} /Pages occupied by compressor/ {compressed=\$5} /File-backed pages/ {print \$3; files=\$3} /Pageouts/ {pageout=\$2} END { printf(\"%%.2f\", (active+inactive+wired+compressed+speculative-purgeable-files)*16384/1024/1024/1024)}')"

%else
 #linux  
    set-option -g @eval_cpu_temp "#(sensors | sed -e 's/^Tccd/Core /' | awk -v format="%%2.0f" '/^Core [0-9]+/ {gsub(\"[^0-9.]\", \"\", \$3); sum+=\$3; n+=1} END {printf(format, sum/n)}')"
    set-option -g @eval_cpu_pct "#(iostat -c 1 2 | sed '/^\s*\$/d' | tail -n 1 | awk -v format=\"%%2.0f\" '{usage=100-\$NF} END {printf(format, usage)}' | sed 's/,/./')"

# htop may slightly differ because it somehow considers shared memory as "free"-able
# According to Linus Torvalds, memory usage should be measured by doing Total - Available (computed from /proc/meminfo or 'free' which does the same thing)
    set-option -g @eval_ram_total "#(free -m | awk '/Mem/ {printf(\"%%.2fG\", \$2 / 1024)}')"
    set-option -g @eval_ram_usage "#(free -m | awk '/Mem/ {printf(\"%%.2f\", (\$2-\$7)/1024)}')"

%endif
    

set -ag status-right "#[fg=#{@thm_blue_dark}]ÓÇ∂‚ñà"
set -ag status-right "#[fg=#{@thm_white},bg=#{@thm_blue_dark}]Û∞ù™#{E:@eval_cpu_pct}%% | #{E:@eval_cpu_temp}ÓåæC "

set -ag status-right "#[fg=#{@thm_yellow_dark}]‚ñà"
set -ag status-right "#[fg=#{@thm_white},bg=#{@thm_yellow_dark}]Ôîû #{E:@eval_ram_usage} / #{E:@eval_ram_total} "

# set -ag status-right "#[fg=#{@thm_yellow},bg=#{@thm_grey_dark}]ÓÇ¥"
set -ag status-right "#[fg=#{@thm_purple_dark}]‚ñà"
set -ag status-right "#[fg=#{@thm_white},bg=#{@thm_purple_dark}]Ôà≥ #h "

if-shell '[ -n "$SSH_CONNECTION" ]' {
    set -ag status-right "#[fg=#{@thm_white}]"
    set -ag status-right "#[fg=#{@thm_white},bg=#{@thm_white}] SSH "
}


set -ag status-right "#[fg=#{@thm_green_dark}]‚ñà"
set -ag status-right "#[fg=#{@thm_white},bg=#{@thm_green_dark}]%Y-%m-%d %H:%M:%S "

set -ag status-right "#[fg=#{@thm_grey_dark}] ‚ñà"
set -ag status-right "#[fg=#{@thm_white},bg=#{@thm_grey_dark}]Óûï #{session_name} "
set -ag status-right "#[fg=#{@thm_grey_light},bg=#{@thm_grey_dark}]"

set -g status-right-length 100

# load plugins
# run-shell '~/.config/tmux/plugins/tmux-resurrect/resurrect.tmux'
# run-shell '~/.config/tmux/plugins/tmux-cpu/cpu.tmux'
# run '~/.config/tmux/plugins/catppuccin/tmux/catppuccin.tmux'

# run '~/.config/tmux/plugins/tpm/tpm'
# use prefix + I to install tmux plugins
# use prefix + alt + u to uninstall
# set -g @plugin 'catppuccin/tmux'
# set -g @plugin 'tmux-plugins/tmux-cpu'

